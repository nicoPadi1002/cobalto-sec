---
title: 'De Cero a SOC en 7 DÃ­as: CÃ³mo ConstruÃ­ mi Sistema de DetecciÃ³n de Amenazas'
date: '2025-11-11T00:00:00'
lastmod: '2025-11-11T00:00:00'
summary: 'Sprint profesional de 7 dÃ­as: Wazuh sobre Proxmox y Docker, arquitectura LXC y smoke tests; proyecto orientado a empleabilidad y evidencias medibles.'
tags:
  [
    'proyecto',
    'tutorial',
    'siem',
    'wazuh',
    'proxmox',
    'docker',
    'soc',
    'home-lab',
    'soar',
    'serie-cobalto-sec',
  ]
draft: false
authors: ['default']
images: ['/static/images/soc-week01/dashboard-principal.png']
---

> **Note:** Este es el **primer post** de la serie _SOAR Inteligente_ (Semana 1/8), planteado como un **sprint profesional**. El objetivo es demostrar **criterio de arquitectura, troubleshooting y mÃ©tricas** que interesan a un hiring manager.

## 1. Hook: del plan al SOC operativo

ArranquÃ© un **sprint de 7 dÃ­as** con un objetivo concreto: **desplegar un SOC funcional endâ€‘toâ€‘end** que evidencie decisiones tÃ©cnicas, control de riesgos y resultados medibles.

Hoy tengo un **Security Operations Center** casero detectando ataques en tiempo real, procesando **500+ eventos por hora** y alertando sobre comportamientos sospechosos en menos de **10 segundos**. Todo corre en **hardware reciclado**, **software open source** y consume **menos recursos** que una VM de Windows.

Esta es la ruta que seguÃ­ (errores incluidos) y cÃ³mo podÃ©s replicarla.

![Dashboard Wazuh mostrando eventos en tiempo real](/static/images/soc-week01/dashboard-principal.png)

---

## 2. El "por quÃ©": valor para contrataciÃ³n

Este proyecto estÃ¡ pensado para que un hiring manager pueda verificar **impacto** en los primeros 60 segundos:

- **Arquitectura clara** (Proxmox + LXC + Docker + Wazuh)
- **MÃ©tricas** verificables (500+ eventos/h, menos de 10s latencia)
- **Pruebas reproducibles** (smoke tests y runbook)

### Â¿QuÃ© es un SIEM? (la analogÃ­a simple)

Un SIEM es como un **sistema de cÃ¡maras inteligente** para tu infraestructura.

- Las "cÃ¡maras" son los **logs**
- La "analÃ­tica" es la **correlaciÃ³n** en tiempo real
- El "guardia" es el **motor de alertas** que avisa durante el incidente

**Ejemplo concreto:** 100 intentos fallidos de SSH en 2 minutos.

- **Sin SIEM:** viven en `/var/log/auth.log`. Tal vez lo veas tarde
- **Con SIEM:** se detecta el patrÃ³n "muchos fallos desde la misma IP en poco tiempo", eleva la alerta y, si querÃ©s, **bloquea automÃ¡ticamente**

> **Tip:** TrabajÃ¡ siempre con **patrones** (reglas, correlaciones) antes que con eventos aislados. Ahorra ruido y te acerca a incidentes reales.

---

## 3. Decisiones de arquitectura: Proxmox + LXC + Docker + Wazuh

QuerÃ­a un stack **estable, barato y replicable**. Las decisiones clave fueron:

1. **Proxmox** como hipervisor (en lugar de VMware/VirtualBox): enterprise-grade, gratuito, **backups y snapshots nativos**
2. **LXC** para el manager de Wazuh (no VM): arranca en **2-3 segundos**, comparte kernel del host y gasta ~**300 MB** de RAM
3. **Docker** **dentro** del LXC (sÃ­, en capas): el despliegue oficial de Wazuh en contenedores funciona perfecto
4. **Wazuh** como SIEM: 100% open source, docs claras, comunidad activa; evitÃ© Splunk por costos y ELK puro por complejidad

### VirtualizaciÃ³n: 3 niveles (y por quÃ© elegÃ­ 2+3)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AplicaciÃ³n (Wazuh)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ Â¿DÃ³nde corre?

Nivel 1: MÃ¡quina Virtual (VM)
â”œâ”€ Sistema operativo completo
â”œâ”€ Kernel propio
â”œâ”€ Overhead: ~2GB RAM mÃ­nimo
â”œâ”€ Aislamiento: MÃ¡ximo
â””â”€ Boot time: 30-60 segundos

Nivel 2: LXC Container
â”œâ”€ Comparte kernel del host
â”œâ”€ Pero tiene systemd, SSH, cron
â”œâ”€ Overhead: ~300MB RAM
â”œâ”€ Aislamiento: Alto
â””â”€ Boot time: 2-3 segundos â† ElegÃ­ esto

Nivel 3: Docker Container
â”œâ”€ Comparte kernel
â”œâ”€ Single-process por container
â”œâ”€ Overhead: ~100MB RAM
â”œâ”€ Aislamiento: Medio
â””â”€ Boot time: menos de 1 segundo

Mi setup: LXC (nivel 2) que CONTIENE Docker (nivel 3)
Por quÃ©: Balance perfecto para home lab
```

**Arquitectura final (Semana 1):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Proxmox Host (192.168.0.115)        â”‚
â”‚  - Hypervisor                        â”‚
â”‚  - 8GB RAM, 2 cores dedicados        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LXC 100     â”‚  â”‚ VM 001      â”‚
â”‚ Wazuh Mgr   â”‚  â”‚ Ubuntu      â”‚
â”‚ 192.168.0.120â”‚  â”‚ Agent       â”‚
â”‚             â”‚  â”‚ .121        â”‚
â”‚ â”œâ”€ Docker   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”œâ”€ Manager  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”œâ”€ Indexer  â”‚  â”‚ VM 002      â”‚
â”‚ â””â”€ Dashboardâ”‚  â”‚ Apache      â”‚
â”‚             â”‚  â”‚ Agent       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ .122        â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Recursos totales:
- LXC: 4GB RAM, 30GB disco
- VM1: 2GB RAM, 10GB disco
- VM2: 2GB RAM, 10GB disco
Total: 8GB RAM, 50GB disco
```

![Proxmox UI mostrando LXC y VMs](/static/images/soc-week01/proxmox-resources.png)

> **Warning:** El stack con **OpenSearch/Elasticsearch** en el backend **come disco**. CalculÃ¡ **30â€“50 GB** como mÃ­nimo para entornos chicos.

---

## 4. El deploy (con los tropiezos reales)

No fue lineal. Esto fue lo que **terminÃ³ funcionando**:

**Paso 1: Crear LXC en Proxmox**  
LXC con 4GB RAM y 30GB disco; red puenteada para IP fija `192.168.0.120`.

**Paso 2: Preparar para Docker**  
Habilitar features necesarios y desplegar Docker dentro del LXC (omito pasos triviales del SO).

**Paso 3: Desplegar Wazuh (single-node)**  
UsÃ© el despliegue en contenedores con `docker compose` apuntando a la **versiÃ³n estable** (ver aprendizaje en Error #1).

**Paso 4: Crear VMs agentes**  
Dos VMs Ubuntu: `192.168.0.121` (agent general) y `192.168.0.122` (Apache).

**Paso 5: Registrar agentes**  
Alta manual y verificaciÃ³n con `agent_control`.

### Errores que me enseÃ±aron mÃ¡s que los aciertos

#### Error #1: Versiones incompatibles

**Problema:**

- InstalÃ© Wazuh Manager 4.14.0
- Bug conocido en Filebeat
- Indexer no recibÃ­a datos
- Dashboard vacÃ­o

**Diagnosis:**

```bash
docker logs single-node-wazuh.manager-1 | grep ERROR
# Output: "Filebeat connection refused"
```

**SoluciÃ³n:**

- **Downgrade a 4.9.2** (versiÃ³n estable)
- **Regenerar certificados SSL**
- 2 horas perdidas, lecciÃ³n aprendida

> **Lesson Learned:** "Latest" â‰  "mejor". Para producciÃ³n casera, elegÃ­ **LTS/estable**.

#### Error #2: Disco lleno

**SÃ­ntoma:**

```bash
df -h
# Output: /dev/mapper/pve-vm--100--disk--0  20G  19G  0  100% /
```

**Arreglo:**

- Expandir disco en Proxmox (20GB â†’ 30GB)
- `resize2fs` dentro del LXC

```bash
resize2fs /dev/mapper/pve-vm--100--disk--0
```

> **Tip:** PlanificÃ¡ el **crecimiento del Ã­ndice**. La ingesta de logs reales se acumula en dÃ­as.

#### Error #3: Agentes "Never connected"

**SÃ­ntoma:**

- El agente decÃ­a "Connected" en su log, pero el Manager lo listaba como "Never connected".

**Comprobaciones:**

```bash
# En VM agente
sudo tail -f /var/ossec/logs/ossec.log
# "INFO: Connected to 192.168.0.120:1514"

# En Manager
docker exec -it single-node-wazuh.manager-1 \
  /var/ossec/bin/agent_control -l
# Agent 001: Never connected
```

**Causa raÃ­z:** El agente **no estaba registrado** en el Manager.  
**SoluciÃ³n:**

```bash
# Registrar manualmente
docker exec -it single-node-wazuh.manager-1 \
  /var/ossec/bin/manage_agents
# A) Add agent
# Name: wazuh-agent
# IP: 192.168.0.121
```

> **Lesson Learned:** **Conectar** â‰  **Registrar**. Son pasos distintos.

![Terminal mostrando error y soluciÃ³n](/static/images/soc-week01/error-agente-never-connected.png)

---

## 5. La primera detecciÃ³n real (SSH brute force)

Con Wazuh up, agentes conectados y logs fluyendo, probÃ© un test simple:

**Simular brute force SSH:**

```bash
# Desde mi PC
for i in {1..5}; do
  ssh fake_user_$i@192.168.0.121
  # Fallar password intencionalmente
  sleep 2
done
```

En `auth.log` del servidor:

```
Nov 11 10:30:15 wazuh-agent sshd[1234]: Failed password for invalid user fake_user_1 from 192.168.0.115
Nov 11 10:30:17 wazuh-agent sshd[1235]: Failed password for invalid user fake_user_2 from 192.168.0.115
Nov 11 10:30:19 wazuh-agent sshd[1236]: Failed password for invalid user fake_user_3 from 192.168.0.115
Nov 11 10:30:21 wazuh-agent sshd[1237]: Failed password for invalid user fake_user_4 from 192.168.0.115
Nov 11 10:30:23 wazuh-agent sshd[1238]: Failed password for invalid user fake_user_5 from 192.168.0.115
```

**Alerta generada (Wazuh):**

- Rule ID: **5710** (SSH authentication failed)
- Level: **5 (Medium)**
- Count: **5 events**
- Source IP: **192.168.0.115**
- Target: **192.168.0.121**
- Timestamp: **real-time**

Y sÃ­, **funcionÃ³**. ğŸ‰ Ese momento justifica horas de setup.

![Alerta SSH rule 5710 en Wazuh](/static/images/soc-week01/alerta-ssh-5710.png)

> **Tip:** Para _smoke tests_ reproducibles, guardÃ¡ tus **consultas de Threat Hunting** (filtros por `rule.id`, `agent.name`, etc.).

---

## 6. MÃ¡s allÃ¡ de SSH: FIM, sudo y HTTP

**1) File Integrity Monitoring (FIM)**  
Monitoreo en: `/etc`, `/usr/bin`, `/usr/sbin`, `/var/www/html`.

**Test FIM:**

```bash
sudo nano /etc/hosts
# Agregar lÃ­nea: # TEST FIM
# Guardar
```

**Resultado (~2 min):**

- Alerta: "Integrity checksum changed"
- File: `/etc/hosts`
- Level: **7 (High)**
- Con **diff** de cambios

**2) Comandos sudo sospechosos**  
Wazuh registra comandos elevando contexto:

```bash
sudo cat /etc/shadow
# Alerta: Level 3 (Low)
# User accessed password file

sudo nmap localhost
# Alerta: Level 5 (Medium)
# Port scanning detected
```

**3) Apache logs (VM 002)**  
Simulo 404s para ver recon:

```bash
# Generar 404s masivos (simulaciÃ³n scan)
for i in {1..6}; do
  curl http://192.168.0.122/fake$i.php
done
```

**Alerta:**

- Rule ID: **31101**
- "Web server 400 error code"
- Count: **6** en **30** segundos
- PatrÃ³n de **reconocimiento** (recon)

![MÃºltiples tipos de alertas â€” SSH, FIM, sudo, HTTP](/static/images/soc-week01/alertas-multiples.png)

> **Note:** Estos tests no buscan "romper" nada. Son seÃ±ales controladas para verificar ingesta, normalizaciÃ³n, correlaciÃ³n y alerta.

---

## 7. MÃ©tricas y estado actual (Semana 1)

DespuÃ©s de 7 dÃ­as corriendo:

**Infraestructura**

- Uptime: **99.8%** (1 reinicio por expansiÃ³n de disco)
- Eventos procesados: **~80,000**
- Alertas generadas: **~150** (reales + pruebas)
- Agentes activos: **2/2 (100%)**

**Performance**

- Latencia eventoâ†’alerta: ** menos de 2 s**
- CPU promedio: **15â€“20%** (picos 40%)
- RAM: **3.2 GB / 4 GB (80%)**
- Disco: **16 GB / 30 GB (52%)**

**DetecciÃ³n**

- Intentos SSH: **45+**
- Cambios FIM: **12**
- Comandos sudo: **230+**
- HTTP requests: **1,200+**

**False positives:** ~**5%** (mayormente mis propias pruebas)

**Tabla de control:**

| MÃ©trica          | Objetivo | Real  | Estado |
| ---------------- | -------- | ----- | ------ |
| Agentes activos  | 2        | 2     | âœ…     |
| Uptime           | 95%      | 99.8% | âœ…     |
| Tiempo respuesta | 10s      | 2s    | âœ…     |
| Eventos/hora     | 100+     | 500+  | âœ…     |
| Disk usage       | 80%      | 52%   | âœ…     |

![GrÃ¡ficos de performance: CPU, RAM, eventos/tiempo](/static/images/soc-week01/metricas-performance.png)

> **Tip:** BajÃ¡ el ruido con listas de **suppress/ignore** acotadas, no a ciegas. EmpezÃ¡ por fuentes hiper-verborreicas (p. ej., `auth.log` en brute force continuo).

---

## 8. Smoke tests (para que tu setup diga "estoy vivo")

**Test 1: Proxmox accesible**

```bash
# Navegador
https://192.168.0.115:8006
```

âœ… Esperado: login de Proxmox

**Test 2: Wazuh Dashboard UP**

```bash
# Navegador
https://192.168.0.120:443
```

âœ… Esperado: login de Wazuh  
Credenciales: `admin / SecretPassword`

**Test 3: Contenedores Docker corriendo**

```bash
# SSH al LXC
ssh root@192.168.0.120

# Ver contenedores
cd /opt/wazuh-docker/wazuh-docker-4.9.2/single-node/
docker compose ps
```

âœ… Esperado:

```
NAME                              STATUS
single-node-wazuh.dashboard-1     Up 2 days
single-node-wazuh.indexer-1       Up 2 days
single-node-wazuh.manager-1       Up 2 days
```

**Test 4: Agentes registrados y activos**

```bash
# En el LXC Manager
docker exec -it single-node-wazuh.manager-1 \
  /var/ossec/bin/agent_control -l
```

âœ… Esperado:

```
Wazuh agent_control. List of available agents:
   ID: 000, Name: wazuh.manager (server), IP: 127.0.0.1, Active/Local
   ID: 001, Name: wazuh-agent, IP: 192.168.0.121, Active
   ID: 002, Name: apache-server, IP: 192.168.0.122, Active
```

Keyword clave: **Active**

**Test 5: Logs fluyendo**

```
Dashboard â†’ Threat Hunting â†’ Events
Time range: Last 15 minutes
```

âœ… Esperado: lista de eventos (mÃ­nimo 10+)  
Eventos tÃ­picos: Login successful, Sudo command, File access, Network connection

**Test 6: Alerta SSH (CRÃTICO)**

```bash
# Desde otra PC
for i in {1..5}; do
  timeout 3 ssh fake$i@192.168.0.121 2>/dev/null || true
  sleep 1
done
```

Luego en Dashboard â†’ Events  
Filtro: `rule.id:5710` (Last 5 minutes)  
âœ… Esperado: 5+ eventos, Level 5, "authentication failed", source = tu IP

**Test 7: File Integrity Monitoring**

```bash
# SSH al agente
ssh wazuh@192.168.0.121

# Modificar archivo monitoreado
sudo nano /etc/hosts
# Agregar:
# 127.0.0.1 test-fim
```

Esperar 2â€“5 min â†’ Dashboard â†’ Events â†’ Filtro: `rule.groups:syscheck`  
âœ… Esperado: "Integrity checksum changed", file `/etc/hosts`, Level 7

---

## 9. Lo que aprendÃ­ (tÃ©cnico y no tÃ©cnico)

**TÃ©cnico**

1. **Arquitectura SIEM:** patrÃ³n agentâ€“manager, normalizaciÃ³n, correlaciÃ³n y severidad
2. **ContainerizaciÃ³n en capas:** LXC vs Docker vs VM; cuÃ¡ndo conviene cada uno
3. **Networking en Proxmox:** bridges (`vmbr0`), IPs fijas, y segmentaciÃ³n bÃ¡sica
4. **Troubleshooting sistemÃ¡tico:** logs primero, dividir el problema, reproducir, documentar

**No tÃ©cnico**

1. **Los errores son contenido.** Discos al 100% me enseÃ±aron mÃ¡s que cualquier "happy path"
2. **Versionado de configs.** PerdÃ­ reglas custom una vez; ahora, **backup** antes de cada cambio
3. **PlanificaciÃ³n antes de ejecutar.** Dibujar la arquitectura ahorra reprocesos
4. **"Good enough" > perfecto.** Lanzar temprano te da feedback real

> **Lesson Learned:** Si una mÃ©trica te importa, **definila y medila** desde el dÃ­a 1 (uptime, eventos/h, FP%). DespuÃ©s sÃ³lo la vas afinando.

---

## 10. PrÃ³ximos pasos (hoja de ruta de la serie)

**Semana 1:** âœ… SIEM funcionando  
**Semana 2:** **SOAR** con **Shuffle** (bloquear IP automÃ¡ticamente ante brute force)  
Semanas 3â€“8: **Threat Intelligence (MISP)**, **detecciÃ³n con ML**, **NLP/LLM local**, **honeypots**, **Grafana**, **hardening** y **lanzamiento pÃºblico**.

**Meta final del proyecto:**

1. Detectar amenazas (**hecho**)
2. **Responder automÃ¡ticamente** (la prÃ³xima)
3. Aprender de patrones (ML)
4. Mejorar solo (feedback loop)

---

## 11. Cierre

De un **plan** a un **SOC operativo** en 7 dÃ­as.  
Hardware: reciclado. Software: open source. Proceso: documentado y medible.

La prÃ³xima semana, este SIEM **se defiende solo**.

**Â¿Te sirviÃ³ esto?** Dame feedback por [LinkedIn](#) o [GitHub](#).  
**Â¿Te trabaste en algÃºn paso?** ComentÃ¡ el error especÃ­fico y lo debuggeamos juntos.  
Si querÃ©s el **repo completo** con configs y scripts, comentÃ¡ "REPO" abajo o etiquetame.

**Serie SOAR Inteligente**

- âœ… Semana 1: SIEM bÃ¡sico (este post)
- ğŸ”œ Semana 2: SOAR â€“ AutomatizaciÃ³n
- ğŸ”œ Semana 3: Threat Intelligence
- ğŸ”œ Semanas 4â€“8: ML, NLP, Honeypots, Dashboards

**Recursos**

- [Wazuh Documentation](https://documentation.wazuh.com/)
- [Proxmox VE](https://www.proxmox.com/)
- Mi GitHub con configs (prÃ³ximo post)
- Diagrama de arquitectura (prÃ³ximo commit)

---
